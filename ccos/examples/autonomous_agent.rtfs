;; Autonomous Agent Loop

(tool/log "Starting Autonomous Agent...")

;; Define the loop function
(defn agent-loop [current_goal]
  (do
    (tool/log (str "Current Goal: " current_goal))
    
    ;; 1. Build Menu
    (let [menu_result (call "planner.build_menu" {:goal current_goal})
          menu (get menu_result "menu")]
      (tool/log (str "Built Menu: " menu))
      
      ;; 2. Synthesize Plan
      (let [synth_result (call "planner.synthesize" {:goal current_goal :menu menu})
            plan (get synth_result "plan")]
        (tool/log (str "Synthesized Plan: " plan))
        
        ;; 3. Validate Plan
        (let [val_result (call "planner.validate" {:plan plan :menu menu})]
          (if (get val_result "valid")
            (do
              (tool/log "Plan is valid. Executing...")
              ;; 4. Execute Plan Steps
              (let [steps (get plan "steps")]
                (for [step steps]
                  (do
                    (tool/log (str "Executing Step: " (get step "id") " (" (get step "capability_id") ")"))
                    (let [result (call "planner.execute_step" {:capability_id (get step "capability_id") :inputs (get step "inputs")})]
                      (tool/log (str "Step Result: " result))
                    )
                  )
                )
              )
              (tool/log "Plan execution complete.")
            )
            (tool/log (str "Plan validation failed: " (get val_result "errors")))
          )
        )
      )
    )
    
    ;; 5. Ask for next goal
    (let [next_goal (call "ccos.user.ask" "What is your next goal? (or 'exit')")]
      (if (and (!= next_goal "exit") (!= next_goal ""))
        (agent-loop next_goal)
        (tool/log "Exiting.")
      )
    )
  )
)

;; Start with initial goal
(agent-loop "search for 'ccos' in workspace")
