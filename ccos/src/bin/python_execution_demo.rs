//! Simple Python Execution Demo
//!
//! Verifies:
//! 1. Sandboxing: Isolation from host filesystem.
//! 2. File Mounting: Readable host files inside sandbox.
//! 3. Output Capture: stdout, stderr, and generated files.

use ccos::sandbox::{BubblewrapSandbox, InputFile, SandboxConfig};
use rtfs::runtime::error::RuntimeResult;
use std::fs;
use std::path::PathBuf;

#[tokio::main]
async fn main() -> RuntimeResult<()> {
    println!("üöÄ Starting Python Execution Demo");
    println!("=================================");

    let sandbox = BubblewrapSandbox::new()?;
    let config = SandboxConfig::default();

    // 1. Test: Normal execution
    println!("\n[Test 1] Basic Execution");
    let code1 =
        "print('Hello from Sandbox!')\nimport sys\nprint('Error to stderr', file=sys.stderr)";
    let result1 = sandbox
        .execute_python(code1, &[], &config, None, None)
        .await?;
    println!("Success: {}", result1.success);
    println!("Stdout: {}", result1.stdout.trim());
    println!("Stderr: {}", result1.stderr.trim());

    // 2. Test: Isolation (Safe failure)
    println!(
        "\n[Test 2] Isolation Check (Expecting failure or empty result when reading /etc/passwd)"
    );
    let code2 = "try:\n    with open('/etc/passwd', 'r') as f:\n        print(f.read())\nexcept Exception as e:\n    print(f'Caught expected error: {e}')";
    let result2 = sandbox
        .execute_python(code2, &[], &config, None, None)
        .await?;
    println!("Stdout: {}", result2.stdout.trim());

    // 3. Test: File Mounting
    println!("\n[Test 3] File Mounting");
    // Create a temporary dummy file on host
    let host_file_path = PathBuf::from("/tmp/ccos_test_input.txt");
    fs::write(&host_file_path, "Secret data from host!")
        .map_err(|e| rtfs::runtime::error::RuntimeError::Generic(e.to_string()))?;

    let input_files = vec![InputFile {
        name: "test_data.txt".to_string(),
        host_path: host_file_path.clone(),
    }];

    let code3 = "with open('/workspace/input/test_data.txt', 'r') as f:\n    print(f'Mounted content: {f.read()}')";
    let result3 = sandbox
        .execute_python(code3, &input_files, &config, None, None)
        .await?;
    println!("Success: {}", result3.success);
    println!("Stdout: {}", result3.stdout.trim());

    // Clean up host file
    let _ = fs::remove_file(host_file_path);

    // 4. Test: Output Files
    println!("\n[Test 4] Output Files");
    let code4 = "with open('/workspace/output/result.txt', 'w') as f:\n    f.write('Generated by sandbox!')\nprint('Output file written')";
    let result4 = sandbox
        .execute_python(code4, &[], &config, None, None)
        .await?;
    println!("Success: {}", result4.success);
    if let Some(content) = result4.output_files.get("result.txt") {
        println!("Found result.txt: {}", String::from_utf8_lossy(content));
    } else {
        println!("‚ùå result.txt NOT found in output_files");
    }

    println!("\n‚úÖ Demo Complete!");
    Ok(())
}
